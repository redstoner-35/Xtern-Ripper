### 概述

这是和[FlashLightOS](https://gitee.com/redstoner-thirty-five/flash-light-os "固件地址")固件所搭配的Xtern Ripper V1.0的硬件平台。也是该固件的官方首发平台。该硬件平台一共有三块PCB,分别是功率板,MCU板和侧按PCB。

### 工程结构

该工程一共有四个文件夹，分别对应四套PCB。文件格式为Altium Designer各个PCB作用如下：

+ PCB-DiffTorch-PowerStage：这个文件夹包含完成降压恒流DCDC变换的功率级，电池功率计以及线性和PWM调光的电路,以及辅助电源的底板PCB。
+ PCB-DiffTorch-MCU：这个文件夹包含MCU相关的外围电路，以及按键去抖和配置EEPROM,包括typec console口和DFU功能的相关电路。
+ PCB-DiffTorch-SideKey：这个文件夹包含这套驱动配套使用的LED侧按按键板，通过细排线连接到驱动上层的子板。侧按板直径12mm，适配东东海D8B外壳。
+ PCB-DiffTorch-BattTypecCharger：这个文件夹包含给东东海D8B外壳配套的Typec充电节所准备的三锂电串联直充板子。此驱动并不依赖于此PCB。

### 焊接调试注意事项

这个工程包含120+元器件，三块PCB，而且有非常小且高引脚密度的QFN和SON-8芯片（最小封装2x2mm），大量的SOT323和0402原件，因此对焊接者的手工有非常高的要求。焊接工具方面需要的准备如下：

+ 加热台
+ 趁手的大功率恒温刀头烙铁（例如JBC245）
+ 高质量的焊锡
+ 高性能的恒温旋风热风枪
+ BGA焊接用的那种高品质助焊剂
+ 63/37配方的有铅中温锡膏
+ 高质量的镊子
+ 吸锡带（用来处理typec座子和QFN连锡）
+ 万用表

#### MCU上层子板的调试焊接

首先应该焊接的是MCU子板，这块板子会比较难焊接，我建议的焊接顺序如下：

1. 使用有铅锡膏和加热台贴装正面的QFN-32封装的HT32F52352单片机
2. 在加热台上面趁热用烙铁给PCB所有焊盘上锡。然后风枪焊接PCB正面所有的芯片（一共2个SOT32*，一个SOT23-3的LDO，一个MSOP-10的USBMUX）
3. 焊接PCB正面的两个二极管
4. 焊接PCB正面所有的0402和0603封装的电阻电容
5. 使用锡膏+风枪贴装背面的UDFN-8封装的FM24C512D EEPROM（此芯片体积极小，容易连锡，先贴装会比较好处理一些）
6. 用烙铁给背面所有贴片焊盘上锡，贴装背面的MSOP-10封装的CH340E
7. 贴装背面所有的0402封装的电阻电容
8. 贴装背面的3225晶振,二极管和SOT323的2N7002KW

全部贴装完毕之后，就需要利用万用表的二极管档进行按照下图指示的位置（红表笔接如图红框位置的焊盘，黑表笔接黑框位置）进行测试，此时万用表的读数应该在0.4-0.7V之间。如果是0或者很低，则说明有芯片方向反了或者HT32F52352焊接出问题连锡短路，需要处理干净。确保没有短路之后就可以准备开始贴装typec座子。这个座子因为是立贴的，贴装会较为困难，具体步骤如下：

![测试点](img/4.jpg)

1. 用镊子在PCB的Type-c座子上均匀的涂抹薄薄的一层锡膏。
2. 将座子放上去，风枪开320度，风速5-6级，围着座子均匀的打圈圈直到锡膏融化。
3. 熔化后趁热将座子拿下，用烙铁和吸锡带去除掉座子引脚和PCB焊盘上连一起的焊锡。
4. 在PCB上薄薄涂抹一层焊油，将座子放回去
5. 风枪330度风速5-6级围着座子均匀打圈直到焊锡熔化，座子会微微下沉和PCB贴合。
6. 撤走风枪等待冷却。
7. 用烙铁+焊锡将四个固定脚焊接到PCB上。

焊接完毕的成品的正面和背面如下所示：

![成品](img/1.jpg)

焊接完毕后就可以把板子丢进洗板水里面清理干净，下一步则是连接电脑刷机。你需要准备一条typec线（A to C和C to C都支持）然后去合泰半导体官网下载[HT32 Flash Programmer](https://www.holtek.com.cn/documents/10179/6393521/HT32_Flash_Programmer_v109d.exe "HT32 Programmer")然后用镊子短接正面如图所示的两个触点，短接之后插上USB线。此时你应该听到USB设备插入的声音。如果没有声音或者提示未知的USB设备，那你就需要检查你MCU、typec座子、正面那个MSOP-10的USB MUX以及电源部分的SOT23封装的LDO是不是虚焊了。

![正面触点](img/5.jpg)

然后下一步就是打开HT32 Flash Programmer软件，将portname调为USB，接着点击右下角的connect。

![编程中](img/6.jpg)

如果焊接没有问题，软件会提示connected，然后你就需要在Code页面选择随工程一起附带的[debug版本固件](/PCB-DiffTorch-MCU/Firmware/FlashLightOS-Debug-SBT90G2.hex "debug固件")。下面的flash option里面勾选上Erase、Program、Verify，然后点击Programming。此时程序会自动给您的驱动板刷入固件。当程序提示operation success之后，你就可以将小板拔下并重新连接。此时你应该听到设备接入的声音。然后你要干的就是去设备管理器里面看看有没有COM和LPT的子项出来。如果固件正常运行，则会有相应的子项，在我这台电脑上，分配的端口为COM7。

![编程成功](img/7.jpg)
![设备管理器里面的子项](img/8.jpg)

接着就可以打开putty软件，配置好参数然后连接驱动，输入ver然后回车。如果固件正确运行应有如下输出：

![固件输出](img/9.jpg)

如果有输出则说明固件已经成功启动。此时你需要把刷固件的步骤重复一次，为子板刷上随工程一起附带的[Production版本固件](/PCB-DiffTorch-MCU/Firmware/FlashLightOS-Production-SBT90G2.hex "production固件")这一次的话Code页面需要选择附带的production版本固件。刷写完毕后MCU上层板的焊接就完成了。

#### 下层功率板的焊接

下层功率板的焊接难度就相对比较低一些，但是也需要遵循一定的焊接顺序去焊接。因为元器件比较多因此建议每焊一步就测量一次否则最后焊接完上电发现短路就非常难找问题。特别是板子上的那几个体积很小的SOT323-6器件。我建议的焊接顺序如下：

1. 使用锡膏+加热台贴装MP86957，LT3741和AD5693RACPZ这三颗芯片。方法是在焊盘上点一点锡膏，芯片压上去然后丢上加热台加热。当锡膏熔化后用镊子轻压芯片挤出多余的焊锡之后用烙铁拖干净。
2. 贴装完毕后，使用万用表二极管档测量如下的位置，应该有0.3-0.5的压降。如果有地方为0的就需要检查是否连锡，无穷大的话就是虚焊了（每个黑色框表示黑表笔，红色表示红表笔）

![正面测试点](img/10.jpg)

3. 贴装右下角的两颗NC7SB3157P6X。这款芯片有时候淘宝的库存保存条件会很差导致芯片引脚氧化不沾锡，需要对引脚进行活化处理。活化处理的办法是找一块有大焊盘的废弃的PCB，挤出一大坨锡膏。芯片放进去整个引脚包裹住，然后用热风枪把锡膏吹化，之后用镊子夹着芯片使劲的在熔化的焊锡里面摩擦，再用烙铁蹭引脚保证每个脚都粘上银闪闪的焊锡之后再贴装。
4. 烙铁给所有SMD件的焊盘上锡，贴装所有的0402电阻电容。
5. 贴装正面剩下的所有芯片。
6. 贴装辅助电源的电感（XAL4030-472MEC）和输出的钽电容（3216 22uF 10V）
7. 贴装正面的0603以及1210尺寸的MLCC电容

正面所有元器件贴装完毕之后，就可以翻面贴装背后的所有原件，需要注意：正面的大电感是最后贴的，不能着急。背面的原件贴装顺序如下：

1. 贴装背后所有的0402元器件
2. 贴装背面的SOD323二极管和INA199A1DCKR放大器
3. 贴装背面的SMD贴片铜条。位置如下图所示，贴装方法是用烙铁在焊盘上面涂上薄薄一层焊锡然后风枪吹上去。贴片铜条一共有两种规格，分别是[方形3x1.5厚1.0mm](https://item.taobao.com/item.htm?spm=a1z09.2.0.0.5e312e8dNFkk1e&id=679291106491&_u=q3r5eurrbd39 "3x1.5厚1.0mm")以及[方形3x3厚2mm](https://item.taobao.com/item.htm?spm=a1z09.2.0.0.5e312e8dNFkk1e&id=679291106491&_u=q3r5eurrbd39 "3x1.5厚2.0mm")

![铜条位置](img/11.jpg)

4. 贴装背面的2512检流电阻，这个检流电阻是R001规格的。贴装的时候一定要检查开尔文接法的两个焊盘是否顺利上锡。焊接结束后可以用万用表欧姆档测一下正面如下图所示的两个引脚之间的阻值，如果测量结果为近似短路则说明焊接OK。

![正面测试点](img/12.jpg)

5. 贴装背面的0805 MLCC和35V 150uF的钽电容。[TCJU157M035R0100E](https://www.mouser.cn/ProductDetail/KYOCERA-AVX/TCJU157M035R0100E?qs=Rp5uXu7WBW9z8RZr358d7g%3D%3D)这颗钽电容在国内现货极少需要海淘，建议从mouser购买。**注意：大号钽电容贴装之前，一定要上加热台70-80度预烘干6-8小时，然后趁热贴装，否则电容里面的水气会导致电容鼓包报废！**

6. 贴装正面的XAL1010-451MEB大电感。贴装的时候首先在焊盘表面完全覆盖一层薄薄的锡膏，然后电感放到位，风枪开320度，高风速围着电感打圈并时不时吹电感底部和PCB之间的空隙直到焊锡熔化，然后撤走风枪等待冷却即可。

所有器件贴装完毕后，你就需要准备一个可调电源，电压调整至12V，电流0.2A，然后给驱动板子上电。背面中心那个圆形的焊盘为正极，旁边一圈为GND。此时上电后应该没有任何电流（显示0.00几A）如果有电流则说明有芯片焊翻了或者某些地方连锡短路。需要处理干净确保上电没有电流才算成功。然后你需要用万用表电压档在驱动上电的时候测量一下电压（黑表笔接黑框位置，红表笔接红框位置）应当是非常稳定的3.3V。

![正面测试点2](img/13.jpg)

如果你测量到了非常稳定的3.3V，说明驱动的功率板已经准备好了。这个时候你就可以准备焊接引出线然后进行合层操作，将上层MCU子板和功率板装配到一起组成一个整体。

#### 合层操作

此章节暂未完成编写。

----------------------------------------------------------------------------------------------------------------------------------
© redstoner_35 @ 35's Embedded Systems Inc.  2023